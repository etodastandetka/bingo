#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –ª–∏–º–∏—Ç–∞–º–∏ –∏ –∫–µ—à–µ–º Next.js
# 1. –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–∞—Ä–æ–ª–∏ –∫–∞–∑–∏–Ω–æ –≤ –ë–î
# 2. –û—á–∏—â–∞–µ—Ç –∫–µ—à Next.js
# 3. –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

PROJECT_DIR="/var/www/bingo_bot"
cd "$PROJECT_DIR/admin" || exit 1

echo -e "${GREEN}üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –ª–∏–º–∏—Ç–∞–º–∏ –∏ –∫–µ—à–µ–º...${NC}"
echo ""

# 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –≤ –ë–î
echo -e "${YELLOW}1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –∫–∞–∑–∏–Ω–æ –≤ –ë–î...${NC}"
npx tsx scripts/update-casino-passwords.ts

if [ $? -eq 0 ]; then
    echo -e "${GREEN}‚úì –ü–∞—Ä–æ–ª–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã${NC}"
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª–µ–π${NC}"
    exit 1
fi

echo ""

# 2. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 –ø—Ä–æ—Ü–µ—Å—Å–∞
echo -e "${YELLOW}2. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 –ø—Ä–æ—Ü–µ—Å—Å–∞...${NC}"
pm2 stop bingo-admin || true
sleep 2

# 3. –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ Next.js
echo -e "${YELLOW}3. –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ Next.js...${NC}"
rm -rf .next
rm -rf node_modules/.cache
echo -e "${GREEN}‚úì –ö–µ—à –æ—á–∏—â–µ–Ω${NC}"

# 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client (–Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã)
echo -e "${YELLOW}4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client...${NC}"
npm run db:generate || echo -e "${YELLOW}‚ö†Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma (–≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ –Ω—É–∂–Ω–æ)${NC}"

# 5. –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
echo -e "${YELLOW}5. –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞...${NC}"
npm run build

if [ ! -d ".next" ]; then
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .next –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏!${NC}"
    exit 1
fi

echo -e "${GREEN}‚úì –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω${NC}"

# 6. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2
echo -e "${YELLOW}6. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2 –ø—Ä–æ—Ü–µ—Å—Å–∞...${NC}"
cd "$PROJECT_DIR"
pm2 restart bingo-admin
pm2 save

# 7. –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
echo -e "${YELLOW}7. –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (5 —Å–µ–∫—É–Ω–¥)...${NC}"
sleep 5

# 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo ""
echo -e "${GREEN}‚úÖ –ì–æ—Ç–æ–≤–æ!${NC}"
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å PM2:"
pm2 status bingo-admin
echo ""
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ (20 —Å—Ç—Ä–æ–∫):"
pm2 logs bingo-admin --lines 20 --nostream

echo ""
echo -e "${GREEN}üéØ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫:${NC}"
echo "   pm2 logs bingo-admin --lines 50"
echo ""
echo -e "${GREEN}üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏–º–∏—Ç—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏${NC}"

