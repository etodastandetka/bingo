<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>–û–ø–ª–∞—Ç–∞ - Bingo KG</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #1e3a8a 50%, #1e40af 75%, #2563eb 100%);
            color: var(--tg-theme-text-color, #ffffff);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 12px;
            margin: 0;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            position: relative;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(37, 99, 235, 0.15) 0%, transparent 50%);
            pointer-events: none;
        }
        
        .container {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 20px;
            padding: 24px;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8), 
                        0 0 0 1px rgba(59, 130, 246, 0.2);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            position: relative;
            z-index: 1;
            margin: 12px 0;
        }
        
        .header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .header h1 {
            color: var(--tg-theme-text-color, #ffffff);
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .amount {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 16px 0;
            text-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
        }
        
        .timer {
            text-align: center;
            margin: 16px 0;
            font-size: 22px;
            color: #fbbf24;
            font-weight: 700;
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.5);
        }
        
        .block {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 16px;
            margin: 12px 0;
            border: 1px solid rgba(59, 130, 246, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .block-title {
            font-size: 13px;
            font-weight: 600;
            color: #93c5fd;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .qr-container {
            text-align: center;
        }
        
        .qr-code {
            max-width: 180px;
            width: 100%;
            margin: 0 auto;
            background: white;
            padding: 8px;
            border-radius: 12px;
            position: relative;
            border: 2px solid #3b82f6;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .qr-code img {
            width: 100%;
            height: auto;
            display: block;
            position: relative;
            z-index: 1;
            transform: scale(1.15); /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º QR –∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
        }
        
        .bank-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .bank-button {
            padding: 12px 8px;
            border: 2px solid rgba(59, 130, 246, 0.4);
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            min-height: 50px;
        }
        
        .bank-button:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5);
        }
        
        .bank-button.active {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            box-shadow: 0 8px 30px rgba(59, 130, 246, 0.7);
        }
        
        .warning {
            background: var(--tg-theme-secondary-bg-color, #fff3cd);
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 12px;
            margin: 16px 0;
            color: var(--tg-theme-hint-color, #856404);
            font-size: 13px;
        }
        
        .receipt-upload {
            margin-top: 12px;
        }
        
        .upload-area {
            border: 2px dashed rgba(59, 130, 246, 0.5);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(10px);
        }
        
        .upload-area:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.15);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        }
        
        .upload-area.dragover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5);
        }
        
        .upload-icon {
            width: 24px;
            height: 24px;
            margin: 0 auto 6px;
            color: var(--tg-theme-hint-color, rgba(100, 181, 246, 0.6));
        }
        
        .upload-text {
            font-size: 12px;
            color: var(--tg-theme-text-color, #666);
            margin-bottom: 3px;
        }
        
        .upload-hint {
            font-size: 11px;
            color: var(--tg-theme-hint-color, #999);
        }
        
        .receipt-preview {
            margin-top: 12px;
            display: none;
        }
        
        .receipt-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 12px;
            border: 2px solid rgba(100, 181, 246, 0.3);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .receipt-preview.show {
            display: block;
        }
        
        .remove-receipt {
            margin-top: 8px;
            padding: 6px 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #666);
        }
        
        .button {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 24px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 16px;
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        .button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .button:hover::before {
            left: 100%;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.6);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .button.loading {
            position: relative;
            color: transparent;
        }
        
        .button.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 24px;
            }
            
            .amount {
                font-size: 28px;
            }
            
            .bank-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .bank-button {
                padding: 12px 8px;
                font-size: 12px;
                min-height: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </svg>
                –û–ø–ª–∞—Ç–∞
            </h1>
            <div class="amount" id="amount">{{ amount }} KGS</div>
            <div class="timer" id="timer">05:00</div>
        </div>
        
        <div class="block">
            <div class="block-title">QR –∫–æ–¥ –¥–ª—è –ª—é–±–æ–≥–æ –±–∞–Ω–∫–∞</div>
            <div class="qr-container" id="qrContainer">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ QR –∫–æ–¥–∞...</div>
            </div>
        </div>
        
        <div class="block">
            <div class="block-title">–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫</div>
            <div class="bank-buttons" id="bankButtons">
                <!-- –ë–∞–Ω–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </div>
        </div>
        
        <div class="block receipt-upload">
            <div class="block-title">–§–æ—Ç–æ —á–µ–∫–∞ <span id="receiptRequired" style="color: #ef4444;">*</span></div>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                        <circle cx="12" cy="13" r="4"/>
                    </svg>
                </div>
                <div class="upload-text">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ</div>
                <div class="upload-hint" id="receiptHint">JPG, PNG –¥–æ 5MB. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã</div>
            </div>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            <div class="receipt-preview" id="receiptPreview">
                <img id="receiptImage" src="" alt="–ß–µ–∫">
                <button class="remove-receipt" onclick="removeReceipt()">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
        
        <button class="button" id="paidButton" onclick="submitPayment()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                <polyline points="20 6 9 17 4 12"/>
            </svg>
            –Ø –æ–ø–ª–∞—Ç–∏–ª
        </button>
    </div>
    
    <script>
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (–º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å, —É—Å—Ç–∞–Ω–æ–≤–∏–≤ –≤ false)
        const ENABLE_COPY_PROTECTION = true; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ true –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –∑–∞—â–∏—Ç—ã
        
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
        if (ENABLE_COPY_PROTECTION) {
        document.addEventListener('keydown', function(e) {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
            if (e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J')) ||
                (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
                return false;
            }
            // –ë–ª–æ–∫–∏—Ä—É–µ–º Print Screen (—á–∞—Å—Ç–∏—á–Ω–æ)
            if (e.key === 'PrintScreen') {
                e.preventDefault();
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                alert('‚ö†Ô∏è –°–∫—Ä–∏–Ω—à–æ—Ç—ã –∑–∞—â–∏—â–µ–Ω—ã! –ö–∞–∂–¥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞.');
                return false;
            }
        });
        }
        
        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ —á–µ—Ä–µ–∑ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∫–ª–∞–≤–∏—à
        if (ENABLE_COPY_PROTECTION) {
        document.addEventListener('keyup', function(e) {
            // Windows: Win + Shift + S
            if (e.key === 's' && e.shiftKey && (e.metaKey || e.ctrlKey)) {
                setTimeout(() => {
                    alert('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –°–∫—Ä–∏–Ω—à–æ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä. –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º –∑–∞–ø—Ä–µ—â–µ–Ω–∞ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è.');
                }, 100);
            }
        });
        }
        
        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ (–≤–æ–∑–º–æ–∂–Ω–æ –¥–µ–ª–∞—é—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç)
        if (ENABLE_COPY_PROTECTION) {
        let warningShown = false;
        window.addEventListener('blur', function() {
            if (!warningShown) {
                warningShown = true;
                setTimeout(() => {
                    if (document.hidden) {
                        console.warn('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ö–∞–∂–¥—ã–π QR –∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞.');
                    }
                    warningShown = false;
                }, 2000);
            }
        });
        }
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–∞–≤—ã–π –∫–ª–∏–∫
        document.addEventListener('contextmenu', function(e) {
            if (ENABLE_COPY_PROTECTION) {
                e.preventDefault();
                return false;
            }
        });
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        document.addEventListener('selectstart', function(e) {
            if (ENABLE_COPY_PROTECTION) {
                e.preventDefault();
                return false;
            }
        });
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
        document.addEventListener('dragstart', function(e) {
            if (ENABLE_COPY_PROTECTION) {
                e.preventDefault();
                return false;
            }
        });
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
        document.addEventListener('copy', function(e) {
            if (ENABLE_COPY_PROTECTION) {
                e.preventDefault();
                return false;
            }
        });
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å—Ç–∞–≤–∫—É
        document.addEventListener('paste', function(e) {
            if (ENABLE_COPY_PROTECTION) {
                e.preventDefault();
                return false;
            }
        });
        
        // –ó–∞—â–∏—Ç–∞ –æ—Ç DevTools (–±–∞–∑–æ–≤–∞—è)
        if (ENABLE_COPY_PROTECTION) {
        setInterval(function() {
            if (window.outerHeight - window.innerHeight > 200 || 
                window.outerWidth - window.innerWidth > 200) {
                // –í–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç DevTools
                console.clear();
                console.warn('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ö–∞–∂–¥—ã–π QR –∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞.');
            }
        }, 1000);
        }
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        if (ENABLE_COPY_PROTECTION) {
        let lastWidth = window.innerWidth;
        let lastHeight = window.innerHeight;
        setInterval(function() {
            if (Math.abs(window.innerWidth - lastWidth) > 100 || 
                Math.abs(window.innerHeight - lastHeight) > 100) {
                console.warn('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ. QR –∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID: ' + uniqueId);
            }
            lastWidth = window.innerWidth;
            lastHeight = window.innerHeight;
        }, 500);
        }
        
        // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç —á–µ—Ä–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞
        if (ENABLE_COPY_PROTECTION) {
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.warn('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ. QR –∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è.');
            }
        });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        let tg = window.Telegram?.WebApp;
        
        // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
        // –ü—Ä–æ–≤–µ—Ä–∫–∞, –æ—Ç–∫—Ä—ã—Ç–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram
        // if (!tg || !tg.initDataUnsafe?.user) {
        //     // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –Ω–µ –≤ Telegram, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        //     document.body.innerHTML = `
        //         <div style="
        //             background: var(--tg-theme-bg-color, #ffffff);
        //             color: var(--tg-theme-text-color, #000000);
        //             padding: 40px 20px;
        //             height: 100vh;
        //             width: 100vw;
        //             display: flex;
        //             flex-direction: column;
        //             align-items: center;
        //             justify-content: center;
        //             font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        //             text-align: center;
        //         ">
        //             <img src="https://telegram.org/img/t_logo.png" alt="Telegram" style="width: 120px; height: 120px; margin-bottom: 20px;">
        //             <p style="font-size: 18px; margin: 8px 0;"><strong>–£–ø—Å!</strong></p>
        //             <p style="font-size: 18px; margin: 8px 0;">–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω–æ <strong>–≤–Ω—É—Ç—Ä–∏ Telegram!</strong></p>
        //         </div>
        //     `;
        // } else {
        //     // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤ Telegram, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        //     tg.expand(); // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤—Å–µ –æ–∫–Ω–æ
        //     tg.ready(); // –ì–æ–≤–æ—Ä–∏–º Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
        // }
        
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤ Telegram, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        if (tg) {
            tg.expand(); // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤—Å–µ –æ–∫–Ω–æ
            tg.ready(); // –ì–æ–≤–æ—Ä–∏–º Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
        }
        
        // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram WebApp
        function getUserId() {
            // –û—Å–Ω–æ–≤–Ω–æ–π —Å–ø–æ—Å–æ–±: initDataUnsafe.user.id
            if (tg?.initDataUnsafe?.user?.id) {
                const userId = tg.initDataUnsafe.user.id.toString();
                console.log('‚úÖ Got user ID from initDataUnsafe.user.id:', userId);
                return userId;
            }
            
            // Fallback: –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–æ)
            const urlParams = new URLSearchParams(window.location.search);
            const userIdFromUrl = urlParams.get('user_id');
            if (userIdFromUrl) {
                console.log('‚úÖ Got user ID from URL parameter:', userIdFromUrl);
                return userIdFromUrl;
            }
            
            console.warn('‚ö†Ô∏è Could not get user ID from Telegram WebApp');
            return null;
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let amount, requestId, expiresAt, telegramUserId, bankUrls, selectedBank, receiptFile;
        let casinoId, accountId, username, firstName, lastName;
        let paymentSettings = null;
        let requireReceiptPhoto = true; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç—Ä–µ–±—É–µ—Ç—Å—è
        let uniqueId = '{{ unique_id }}' || '';
        let uncreatedRequestId = null;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π URL –¥–ª—è API
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ–º–µ–Ω –∞–¥–º–∏–Ω–∫–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        const API_BASE_URL = window.location.origin.includes('localhost') 
            ? 'http://localhost:3001/api' 
            : 'https://gdsfafdsdf.me/api'; // –î–æ–º–µ–Ω –∞–¥–º–∏–Ω–∫–∏ –∏–∑ domains.json
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–≤—Å–µ–≥–¥–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç Telegram)
        amount = parseFloat('{{ amount }}') || 0;
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º request_id: –µ—Å–ª–∏ –ø—É—Å—Ç–æ–π –∏–ª–∏ 'None', —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
        const requestIdRaw = '{{ request_id }}'.trim();
        requestId = (requestIdRaw && requestIdRaw !== 'None' && requestIdRaw !== 'null' && requestIdRaw !== 'undefined') ? requestIdRaw : '';
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –∏–∑ URL –∏–ª–∏ localStorage
        let createdAtTimestamp = parseInt('{{ created_at_timestamp }}') || null;
        
        // –ï—Å–ª–∏ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –µ—Å—Ç—å –≤ URL, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        if (createdAtTimestamp) {
            localStorage.setItem('payment_created_at', createdAtTimestamp.toString());
        } else {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ localStorage (–¥–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
            const savedCreatedAt = localStorage.getItem('payment_created_at');
            if (savedCreatedAt) {
                createdAtTimestamp = parseInt(savedCreatedAt);
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ
                createdAtTimestamp = Date.now();
                localStorage.setItem('payment_created_at', createdAtTimestamp.toString());
            }
        }
        
        // –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è (5 –º–∏–Ω—É—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è)
        expiresAt = createdAtTimestamp + (5 * 60 * 1000); // 5 –º–∏–Ω—É—Ç –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        telegramUserId = getUserId() || '{{ user_id }}' || '';
        casinoId = '{{ casino_id }}' || '';
        accountId = '{{ account_id }}' || '';
        username = '{{ username }}' || '';
        firstName = '{{ first_name }}' || '';
        lastName = '{{ last_name }}' || '';
        bankUrls = {};
        selectedBank = 'omoney';
        receiptFile = null;
        
        // –í—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –±–∞–Ω–∫–∏ (–±—É–¥—É—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º)
        const allBanks = [
            { id: 'omoney', name: 'O!Money' },
            { id: 'mbank', name: 'MBank' },
            { id: 'bakai', name: 'Bakai' },
            { id: 'demir', name: 'DemirBank' },
            { id: 'demirbank', name: 'DemirBank' }, // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
            { id: 'balance', name: 'Balance.kg' },
            { id: 'megapay', name: 'MegaPay' }
        ];
        
        // –ë–∞–Ω–∫–∏ (–±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
        let banks = [...allBanks];
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ API
        async function loadPaymentSettings() {
            try {
                const response = await fetch(`${API_BASE_URL}/public/payment-settings`);
                const data = await response.json();
                
                if (data.success) {
                    paymentSettings = data;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω—ã –ª–∏ –¥–µ–ø–æ–∑–∏—Ç—ã
                    const depositsEnabled = data.deposits?.enabled !== false;
                    if (!depositsEnabled) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
                        document.body.innerHTML = `
                            <div style="
                                background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #1e3a8a 50%, #1e40af 75%, #2563eb 100%);
                                color: #ffffff;
                                padding: 40px 20px;
                                height: 100vh;
                                width: 100vw;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                text-align: center;
                            ">
                                <div style="font-size: 48px; margin-bottom: 20px;">‚è∏Ô∏è</div>
                                <h1 style="font-size: 24px; margin-bottom: 12px; font-weight: 600;">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω—ã</h1>
                                <p style="font-size: 16px; color: #94a3b8; max-width: 400px;">
                                    ${data.maintenance_message || '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'}
                                </p>
                            </div>
                        `;
                        return;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω–æ –ª–∏ –∫–∞–∑–∏–Ω–æ
                    const casinoEnabled = data.casinos?.[casinoId] !== false;
                    if (!casinoEnabled) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –±–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
                        document.body.innerHTML = `
                            <div style="
                                background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #1e3a8a 50%, #1e40af 75%, #2563eb 100%);
                                color: #ffffff;
                                padding: 40px 20px;
                                height: 100vh;
                                width: 100vw;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                text-align: center;
                            ">
                                <div style="font-size: 48px; margin-bottom: 20px;">üö´</div>
                                <h1 style="font-size: 24px; margin-bottom: 12px; font-weight: 600;">–ö–∞–∑–∏–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</h1>
                                <p style="font-size: 16px; color: #94a3b8; max-width: 400px;">
                                    –í—ã–±—Ä–∞–Ω–Ω–æ–µ –∫–∞–∑–∏–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–µ –∫–∞–∑–∏–Ω–æ.
                                </p>
                            </div>
                        `;
                        return;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ —á–µ–∫–∞
                    requireReceiptPhoto = data.require_receipt_photo !== false;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –±–ª–æ–∫–∞ —Å —á–µ–∫–æ–º
                    const receiptBlock = document.querySelector('.receipt-upload');
                    const receiptRequired = document.getElementById('receiptRequired');
                    const receiptHint = document.getElementById('receiptHint');
                    
                    if (receiptBlock) {
                        if (!requireReceiptPhoto) {
                            receiptBlock.style.display = 'none';
                        } else {
                            receiptBlock.style.display = 'block';
                        }
                    }
                    
                    if (receiptRequired) {
                        receiptRequired.style.display = requireReceiptPhoto ? 'inline' : 'none';
                    }
                    
                    if (receiptHint) {
                        receiptHint.textContent = requireReceiptPhoto 
                            ? 'JPG, PNG –¥–æ 5MB. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã'
                            : 'JPG, PNG –¥–æ 5MB. –ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è';
                    }
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –±–∞–Ω–∫–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º
                    const enabledBanks = data.deposits?.banks || [];
                    if (enabledBanks.length > 0) {
                        banks = allBanks.filter(bank => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ id –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏—è–º
                            return enabledBanks.includes(bank.id) || 
                                   (bank.id === 'demirbank' && enabledBanks.includes('demir')) ||
                                   (bank.id === 'demir' && enabledBanks.includes('demirbank'));
                        });
                        
                        // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã (demir –∏ demirbank)
                        const seen = new Set();
                        banks = banks.filter(bank => {
                            const key = bank.id === 'demir' || bank.id === 'demirbank' ? 'demir' : bank.id;
                            if (seen.has(key)) return false;
                            seen.add(key);
                            return true;
                        });
                        
                        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –±–∞–Ω–∫ –Ω–µ –≤ —Å–ø–∏—Å–∫–µ, –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
                        if (!banks.find(b => b.id === selectedBank || (b.id === 'demir' && selectedBank === 'demirbank') || (b.id === 'demirbank' && selectedBank === 'demir'))) {
                            selectedBank = banks[0]?.id || 'omoney';
                        }
                        
                        // –ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–∞–Ω–∫–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                        if (banks.length === 0) {
                            document.body.innerHTML = `
                                <div style="
                                    background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #1e3a8a 50%, #1e40af 75%, #2563eb 100%);
                                    color: #ffffff;
                                    padding: 40px 20px;
                                    height: 100vh;
                                    width: 100vw;
                                    display: flex;
                                    flex-direction: column;
                                    align-items: center;
                                    justify-content: center;
                                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                    text-align: center;
                                ">
                                    <div style="font-size: 48px; margin-bottom: 20px;">üö´</div>
                                    <h1 style="font-size: 24px; margin-bottom: 12px; font-weight: 600;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–∞–Ω–∫–æ–≤</h1>
                                    <p style="font-size: 16px; color: #94a3b8; max-width: 400px;">
                                        –í—Å–µ –±–∞–Ω–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.
                                    </p>
                                </div>
                            `;
                            return;
                        }
                    }
                    
                    console.log('‚úÖ Payment settings loaded:', {
                        requireReceiptPhoto: requireReceiptPhoto,
                        enabledBanks: enabledBanks,
                        filteredBanks: banks.map(b => b.id),
                        depositsEnabled: depositsEnabled,
                        casinoEnabled: casinoEnabled
                    });
                }
            } catch (error) {
                console.error('‚ùå Error loading payment settings:', error);
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            }
        }

        async function createUncreatedOnce() {
            try {
                if (!telegramUserId || !casinoId || !accountId) {
                    console.warn('‚ö†Ô∏è Cannot create uncreated request: missing user/casino/account');
                    return;
                }
                const storageKey = `uncreated_req_${telegramUserId}_${casinoId}_${accountId}`;
                const storedId = localStorage.getItem(storageKey);
                if (storedId) {
                    uncreatedRequestId = storedId;
                    return;
                }
                const resp = await fetch(`${API_BASE_URL}/public/uncreated-requests`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: telegramUserId,
                        username,
                        firstName,
                        lastName,
                        bookmaker: casinoId,
                        accountId,
                        bank: selectedBank,
                        amount: amount || null,
                        requestType: 'deposit'
                    }),
                });
                const data = await resp.json();
                if (data.success && data.data?.id) {
                    uncreatedRequestId = data.data.id.toString();
                    localStorage.setItem(storageKey, uncreatedRequestId);
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Failed to create uncreated request', e);
            }
        }
        
        console.log('üìä Payment Form Data:', {
            telegramUserId: telegramUserId,
            requestId: requestId,
            amount: amount,
            expiresAt: expiresAt,
            casinoId: casinoId,
            accountId: accountId,
            tgAvailable: !!tg,
            userAvailable: !!tg?.initDataUnsafe?.user
        });
        
        // –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        function updateTimer() {
            const now = Date.now();
            const remaining = expiresAt - now;
            
            if (remaining <= 0) {
                // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è (–≤—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ)
                localStorage.removeItem('payment_created_at');
                
                const timerEl = document.getElementById('timer');
                if (timerEl) {
                    timerEl.textContent = '00:00';
                    timerEl.style.color = '#ef4444';
                }
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ–ø–ª–∞—Ç—ã
                const paidButton = document.getElementById('paidButton');
                if (paidButton) {
                    paidButton.disabled = true;
                    paidButton.textContent = '‚è∞ –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ';
                    paidButton.style.opacity = '0.6';
                }
                
                // –¢–∞–π–º–µ—Ä –∏—Å—Ç–µ–∫ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (tg) {
                    tg.showPopup({
                        title: '‚è∞ –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ',
                        message: '–í—Ä–µ–º—è –Ω–∞ –æ–ø–ª–∞—Ç—É –∏—Å—Ç–µ–∫–ª–æ. –ó–∞—è–≤–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.',
                        buttons: [{ 
                            type: 'ok',
                            text: '–û–ö'
                        }]
                    });
                } else {
                    alert('‚è∞ –í—Ä–µ–º—è –Ω–∞ –æ–ø–ª–∞—Ç—É –∏—Å—Ç–µ–∫–ª–æ. –ó–∞—è–≤–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.');
                }
                return;
            }
            
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            
            const timerEl = document.getElementById('timer');
            if (timerEl) {
                timerEl.textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
        setInterval(updateTimer, 1000);
        updateTimer();
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        async function loadQR() {
            try {
                console.log('üì§ Loading QR code for amount:', amount);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –ª–æ–∫–∞–ª—å–Ω—ã–π API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR —Å –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º
                let response;
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000);
                    
                    response = await fetch('/api/generate-qr', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            amount: amount,
                            bank: (typeof selectedBank !== 'undefined' ? selectedBank : 'omoney'),
                            unique_id: uniqueId
                        }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                } catch (fetchError) {
                    console.error('‚ùå Fetch error loading QR:', fetchError);
                    if (fetchError.name === 'AbortError') {
                        throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                    } else {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ' + fetchError.message);
                    }
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Response error loading QR:', response.status, errorText);
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status}): ${errorText.substring(0, 100)}`);
                }
                
                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    console.error('‚ùå JSON parse error loading QR:', jsonError);
                    const text = await response.text();
                    throw new Error(`–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${text.substring(0, 100)}`);
                }
                
                console.log('‚úÖ QR data received:', { success: data.success, has_image: !!data.qr_image });
                
                if (data.success) {
                    bankUrls = data.all_bank_urls || {};
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º QR –∫–æ–¥ —Å –≤–æ–¥—è–Ω—ã–º –∑–Ω–∞–∫–æ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
                    if (data.qr_image) {
                        const qrContainer = document.getElementById('qrContainer');
                        qrContainer.innerHTML = `
                            <div class="qr-code">
                                <img src="${data.qr_image}" 
                                     alt="QR Code" 
                                     style="width: 100%; height: auto;">
                            </div>
                        `;
                    } else {
                        console.error('‚ùå QR image not found in response');
                        document.getElementById('qrContainer').innerHTML = 
                            `<div class="loading" style="color: #e74c3c;">–û—à–∏–±–∫–∞: QR –∫–æ–¥ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω</div>`;
                    }
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –±–∞–Ω–∫–æ–≤
                    setupBankButtons();
                } else {
                    console.error('‚ùå QR generation failed:', data.error);
                    document.getElementById('qrContainer').innerHTML = 
                        `<div class="loading" style="color: #e74c3c;">–û—à–∏–±–∫–∞: ${data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥'}</div>`;
                }
            } catch (error) {
                console.error('‚ùå Error loading QR:', error);
                console.error('‚ùå Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                document.getElementById('qrContainer').innerHTML = 
                    `<div class="loading" style="color: #e74c3c;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ QR –∫–æ–¥–∞: ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>`;
            }
        }
        
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ –±–∞–Ω–∫–æ–≤ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        function setupBankButtons() {
            const bankButtonsContainer = document.getElementById('bankButtons');
            if (!bankButtonsContainer) {
                console.warn('bankButtons container not found');
                return;
            }
            
            bankButtonsContainer.innerHTML = '';
            
            banks.forEach(bank => {
                const bankUrl = bankUrls[bank.id] || bankUrls[bank.name];
                const button = document.createElement('a');
                button.href = bankUrl || '#';
                button.target = '_blank';
                button.className = 'bank-button';
                if (bank.id === selectedBank) {
                    button.classList.add('active');
                }
                button.textContent = bank.name;
                
                if (bankUrl) {
                    button.onclick = (e) => {
                        e.preventDefault();
                        selectedBank = bank.id;
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                        document.querySelectorAll('.bank-button').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        button.classList.add('active');
                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É
                        window.open(bankUrl, '_blank');
                    };
                } else {
                    // –ï—Å–ª–∏ URL –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π
                    button.style.opacity = '0.5';
                    button.style.cursor = 'wait';
                    button.onclick = (e) => {
                        e.preventDefault();
                    };
                }
                
                bankButtonsContainer.appendChild(button);
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ —á–µ–∫–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        function initReceiptUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const receiptPreview = document.getElementById('receiptPreview');
            const receiptImage = document.getElementById('receiptImage');
            
            if (!uploadArea || !fileInput) return;
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                if (tg) {
                    tg.showPopup({
                        title: '–û—à–∏–±–∫–∞',
                        message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                }
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                if (tg) {
                    tg.showPopup({
                        title: '–û—à–∏–±–∫–∞',
                        message: '–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 5MB',
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 5MB');
                }
                return;
            }
            
            receiptFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                receiptImage.src = e.target.result;
                receiptPreview.classList.add('show');
            };
            reader.readAsDataURL(file);
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —á–µ–∫–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        window.removeReceipt = function() {
            receiptFile = null;
            const receiptImage = document.getElementById('receiptImage');
            const receiptPreview = document.getElementById('receiptPreview');
            const fileInput = document.getElementById('fileInput');
            
            if (receiptImage) receiptImage.src = '';
            if (receiptPreview) receiptPreview.classList.remove('show');
            if (fileInput) fileInput.value = '';
        };
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏ —Å —á–µ–∫–æ–º –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–Ø –æ–ø–ª–∞—Ç–∏–ª" (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        window.submitPayment = async function() {
            console.log('üöÄ submitPayment function called!');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫–ª–æ –ª–∏ –≤—Ä–µ–º—è
            const now = Date.now();
            if (now >= expiresAt) {
                const errorMsg = '‚è∞ –í—Ä–µ–º—è –Ω–∞ –æ–ø–ª–∞—Ç—É –∏—Å—Ç–µ–∫–ª–æ. –ó–∞—è–≤–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.';
                if (tg) {
                    tg.showPopup({
                        title: '–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ',
                        message: errorMsg,
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert(errorMsg);
                }
                return;
            }
            
            console.log('üöÄ Initial data check:', {
                telegramUserId,
                casinoId,
                accountId,
                amount,
                requestId,
                hasReceiptFile: !!receiptFile,
                expiresAt: new Date(expiresAt).toISOString(),
                timeRemaining: Math.floor((expiresAt - now) / 1000) + ' —Å–µ–∫—É–Ω–¥'
            });
            
            // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–∫—Ä—ã—Ç–æ –≤ Telegram
            // if (!tg || !tg.initDataUnsafe?.user) {
            //     if (tg) {
            //         tg.showPopup({
            //             title: '–û—à–∏–±–∫–∞',
            //             message: '–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ –≤ Telegram',
            //             buttons: [{ type: 'ok' }]
            //         });
            //     } else {
            //         alert('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ –≤ Telegram');
            //     }
            //     return;
            // }
            
            const paidButton = document.getElementById('paidButton');
            if (!paidButton) {
                console.error('‚ùå paidButton not found!');
                alert('–û—à–∏–±–∫–∞: –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }
            console.log('‚úÖ paidButton found');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
            if (!telegramUserId || !casinoId || !accountId) {
                console.error('‚ùå Missing required data:', {
                    telegramUserId: !!telegramUserId,
                    casinoId: !!casinoId,
                    accountId: !!accountId
                });
                if (tg) {
                    tg.showPopup({
                        title: '–û—à–∏–±–∫–∞',
                        message: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏',
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏');
                }
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–æ—Ç–æ —á–µ–∫–∞ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º)
            if (requireReceiptPhoto && !receiptFile) {
                if (tg) {
                    tg.showPopup({
                        title: '–í–Ω–∏–º–∞–Ω–∏–µ',
                        message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ —á–µ–∫–∞ –æ–± –æ–ø–ª–∞—Ç–µ. –≠—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞.',
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ —á–µ–∫–∞ –æ–± –æ–ø–ª–∞—Ç–µ. –≠—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞.');
                }
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            paidButton.disabled = true;
            paidButton.classList.add('loading');
            
            try {
                let receiptBase64 = null;
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ñ–æ—Ç–æ —á–µ–∫–∞ –≤ base64 (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                if (receiptFile) {
                    const reader = new FileReader();
                    receiptBase64 = await new Promise((resolve, reject) => {
                        reader.onload = (e) => {
                            const base64 = e.target.result.split(',')[1];
                            resolve(base64);
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(receiptFile);
                    });
                }
                
                // –ï—Å–ª–∏ –∑–∞—è–≤–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (requestId), –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ requestId –Ω–µ –ø—É—Å—Ç–æ–π –∏ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º —á–∏—Å–ª–æ–º
                if (requestId && requestId.trim() !== '' && !isNaN(parseInt(requestId))) {
                    const updateData = {
                        id: parseInt(requestId)
                        // –ù–µ –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                    };
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —á–µ–∫–∞ (base64 —Å—Ç—Ä–æ–∫–∞)
                    if (receiptBase64 && receiptBase64.trim() !== '') {
                        updateData.receipt_photo = receiptBase64.trim();
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º telegram_user_id, –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (telegramUserId && telegramUserId.toString().trim() !== '') {
                        updateData.telegram_user_id = telegramUserId.toString().trim();
                    }
                    if (uncreatedRequestId) {
                        updateData.uncreated_request_id = uncreatedRequestId;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º amount (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º)
                    const amountNum = parseFloat(amount) || 0;
                    if (amountNum > 0) {
                        updateData.amount = amountNum;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –ø—É—Å—Ç—ã–µ
                    if (casinoId && casinoId.trim() !== '') {
                        updateData.bookmaker = casinoId.trim();
                    }
                    
                    if (accountId && accountId.trim() !== '') {
                        updateData.account_id = accountId.trim();
                    }
                    
                    if (selectedBank && selectedBank.trim() !== '') {
                        updateData.bank = selectedBank.trim();
                    }
                    
                    if (username && username.trim() !== '') {
                        updateData.telegram_username = username.trim();
                    }
                    
                    if (firstName && firstName.trim() !== '') {
                        updateData.telegram_first_name = firstName.trim();
                    }
                    
                    if (lastName && lastName.trim() !== '') {
                        updateData.telegram_last_name = lastName.trim();
                    }
                    
                    console.log('üì§ Updating existing request:', {
                        id: updateData.id,
                        has_receipt: !!updateData.receipt_photo,
                        status: updateData.status,
                        amount: updateData.amount,
                        bookmaker: updateData.bookmaker
                    });
                    
                    let response;
                    try {
                        // –°–æ–∑–¥–∞–µ–º AbortController –¥–ª—è —Ç–∞–π–º–∞—É—Ç–∞
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
                        
                        console.log('üì§ Updating request to:', `${API_BASE_URL}/payment`);
                        response = await fetch(`${API_BASE_URL}/payment`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updateData),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                    } catch (fetchError) {
                        console.error('‚ùå Fetch error:', fetchError);
                        if (fetchError.name === 'AbortError') {
                            throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                        } else if (fetchError.message && fetchError.message.includes('Failed to fetch')) {
                            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                        } else {
                            throw new Error(fetchError.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                        }
                    }
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('‚ùå Response error:', response.status, errorText);
                        throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status}): ${errorText.substring(0, 100)}`);
                    }
                    
                    let data;
                    try {
                        data = await response.json();
                    } catch (jsonError) {
                        console.error('‚ùå JSON parse error:', jsonError);
                        const text = await response.text();
                        throw new Error(`–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${text.substring(0, 100)}`);
                    }
                    
                    if (data.success) {
                        // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è (–∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞)
                        localStorage.removeItem('payment_created_at');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º requestId –∏–∑ –æ—Ç–≤–µ—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                        const responseId = data.data?.id || data.id;
                        if (responseId) {
                            requestId = responseId;
                            console.log('‚úÖ Request ID updated from response:', requestId);
                        }
                        
                        console.log('‚úÖ Payment request submitted successfully');
                        
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ø–µ—Ö–∞
                        if (tg && tg.close) {
                            console.log('üîÑ Closing mini app...');
                            tg.close();
                        } else {
                            console.warn('‚ö†Ô∏è Telegram WebApp not available, cannot close mini app');
                        }
                    } else {
                        throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞—è–≤–∫—É');
                    }
                } else {
                    console.log('üìù ========== CREATING NEW REQUEST ==========');
                    console.log('üìù Creating NEW request (not updating existing)');
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º amount –≤ —á–∏—Å–ª–æ
                    const amountNum = parseFloat(amount) || 0;
                    console.log('üí∞ Amount:', amount, '‚Üí', amountNum);
                    
                    if (!amountNum || amountNum <= 0) {
                        console.error('‚ùå Invalid amount:', amountNum);
                        throw new Error('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ –æ–ø–ª–∞—Ç—ã');
                    }
                    
                    console.log('üì¶ Preparing request data...');
                    console.log('üì¶ Data before preparation:', {
                        telegramUserId,
                        casinoId,
                        accountId,
                        username,
                        firstName,
                        lastName,
                        amountNum
                    });
                    
                    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                    const requestData = {
                        telegram_user_id: telegramUserId.toString().trim(), // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å—Ç—Ä–æ–∫–∞
                        type: 'deposit',
                        amount: amountNum, // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —á–∏—Å–ª–æ
                    };
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –ø—É—Å—Ç—ã–µ
                    if (casinoId && casinoId.trim() !== '') {
                        requestData.bookmaker = casinoId.trim();
                    }
                    
                    if (accountId && accountId.trim() !== '') {
                        requestData.account_id = accountId.trim();
                    }
                    
                    if (username && username.trim() !== '') {
                        requestData.telegram_username = username.trim();
                    }
                    
                    if (firstName && firstName.trim() !== '') {
                        requestData.telegram_first_name = firstName.trim();
                    }
                    
                    if (lastName && lastName.trim() !== '') {
                        requestData.telegram_last_name = lastName.trim();
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–Ω–∫, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω
                    if (selectedBank && selectedBank.trim() !== '') {
                        requestData.bank = selectedBank.trim();
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —á–µ–∫–∞ (base64 —Å—Ç—Ä–æ–∫–∞)
                    if (receiptBase64 && receiptBase64.trim() !== '') {
                        requestData.receipt_photo = receiptBase64.trim();
                    }

                    if (uncreatedRequestId) {
                        requestData.uncreated_request_id = uncreatedRequestId;
                    }
                    
                    console.log('üì¶ Request data prepared:', requestData);
                    
                    console.log('üì§ Creating new request:', {
                        telegram_user_id: requestData.telegram_user_id,
                        type: requestData.type,
                        amount: requestData.amount,
                        amount_type: typeof requestData.amount,
                        bookmaker: requestData.bookmaker,
                        account_id: requestData.account_id,
                        bank: requestData.bank,
                        has_receipt: !!requestData.receipt_photo,
                        receipt_length: requestData.receipt_photo ? requestData.receipt_photo.length : 0
                    });
                    
                    console.log('üì§ Full request data to send:', JSON.stringify(requestData, null, 2));
                    console.log('üì§ Sending to:', `${API_BASE_URL}/payment`);
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                    if (!requestData.telegram_user_id) {
                        throw new Error('–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    }
                    if (!requestData.amount || requestData.amount <= 0) {
                        throw new Error('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞ –æ–ø–ª–∞—Ç—ã');
                    }
                    if (!requestData.type) {
                        throw new Error('–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–∏–ø –∑–∞—è–≤–∫–∏');
                    }
                    
                    let response;
                    try {
                        // –°–æ–∑–¥–∞–µ–º AbortController –¥–ª—è —Ç–∞–π–º–∞—É—Ç–∞
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
                        
                        console.log('üì§ Sending POST to:', `${API_BASE_URL}/payment`);
                        response = await fetch(`${API_BASE_URL}/payment`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestData),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        console.log('üì• Response received:', {
                            status: response.status,
                            statusText: response.statusText,
                            ok: response.ok
                        });
                    } catch (fetchError) {
                        console.error('‚ùå Fetch error:', fetchError);
                        console.error('‚ùå Fetch error details:', {
                            name: fetchError.name,
                            message: fetchError.message
                        });
                        if (fetchError.name === 'AbortError') {
                            throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                        } else if (fetchError.message && fetchError.message.includes('Failed to fetch')) {
                            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                        } else {
                            throw new Error(fetchError.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                        }
                    }
                    
                    console.log('üì• Response status:', response.status, response.statusText);
                    
                    let responseText = '';
                    try {
                        responseText = await response.text();
                        console.log('üì• Response text:', responseText.substring(0, 500));
                    } catch (e) {
                        console.error('‚ùå Failed to read response text:', e);
                    }
                    
                    if (!response.ok) {
                        console.error('‚ùå Response error:', response.status, responseText);
                        let errorMessage = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${response.status})`;
                        try {
                            const errorData = JSON.parse(responseText);
                            errorMessage = errorData.error || errorData.message || errorMessage;
                        } catch (e) {
                            errorMessage = responseText.substring(0, 200) || errorMessage;
                        }
                        throw new Error(errorMessage);
                    }
                    
                    let data;
                    try {
                        data = JSON.parse(responseText);
                        console.log('üì• Parsed response data:', data);
                    } catch (jsonError) {
                        console.error('‚ùå JSON parse error:', jsonError);
                        throw new Error(`–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${responseText.substring(0, 100)}`);
                    }
                    
                    if (data.success) {
                        // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è (–∑–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞)
                        localStorage.removeItem('payment_created_at');
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–∑–¥–∞–Ω–Ω–æ–π –∑–∞—è–≤–∫–∏ (–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
                        requestId = data.data?.id || data.data?.transactionId || data.id || data.transactionId;
                        console.log('‚úÖ Request created successfully, ID:', requestId);
                        console.log('‚úÖ Full response data:', JSON.stringify(data, null, 2));
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞—è–≤–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–Ω–∞
                        if (!requestId) {
                            console.error('‚ùå Warning: Request ID is missing in response!', data);
                            // –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å ID –∏–∑ –¥—Ä—É–≥–æ–≥–æ –º–µ—Å—Ç–∞
                            if (data.data && typeof data.data === 'object') {
                                requestId = data.data.id || data.data.requestId || data.data.request_id;
                            }
                        }
                        
                        console.log('‚úÖ Payment request submitted successfully');
                        
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ø–µ—Ö–∞
                        if (tg && tg.close) {
                            console.log('üîÑ Closing mini app...');
                            tg.close();
                        } else {
                            console.warn('‚ö†Ô∏è Telegram WebApp not available, cannot close mini app');
                        }
                    } else {
                        const errorMsg = data.error || data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É';
                        console.error('‚ùå Server returned error:', errorMsg);
                        throw new Error(errorMsg);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error submitting payment:', error);
                console.error('‚ùå Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack,
                    type: typeof error
                });
                
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                paidButton.disabled = false;
                paidButton.classList.remove('loading');
                
                let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
                if (error.message) {
                    errorMessage = error.message;
                } else if (error.name === 'TypeError' && error.message && error.message.includes('fetch')) {
                    errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
                }
                
                if (tg) {
                    tg.showPopup({
                        title: '–û—à–∏–±–∫–∞',
                        message: errorMessage,
                        buttons: [{ type: 'ok' }]
                    });
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + errorMessage);
                }
            }
        };
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞—è–≤–∫–∏
        async function checkExistingRequest() {
            if (!telegramUserId) {
                console.warn('‚ö†Ô∏è Cannot check existing request: no user ID');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram_user_id: telegramUserId,
                        type: 'deposit',
                        amount: 0, // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                    }),
                });

                const data = await response.json();
                
                if (!data.success && data.error) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ –æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞—è–≤–∫–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    if (data.error.includes('–ó–∞—è–≤–∫–∞ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞') || data.error.includes('–í—Ä–µ–º—è –Ω–∞ –æ–ø–ª–∞—Ç—É –∏—Å—Ç–µ–∫–ª–æ')) {
                        const errorMessage = data.error;
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                        if (tg) {
                            tg.showPopup({
                                title: '‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ',
                                message: errorMessage,
                                buttons: [{
                                    type: 'ok',
                                    text: '–ü–æ–Ω—è—Ç–Ω–æ'
                                }]
                            }).then(() => {
                                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è OK
                                if (tg && tg.close) {
                                    tg.close();
                                }
                            });
                        } else {
                            alert(errorMessage);
                        }
                        
                        // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É
                        document.body.innerHTML = `
                            <div style="
                                background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #1e3a8a 50%, #1e40af 75%, #2563eb 100%);
                                color: #ffffff;
                                padding: 40px 20px;
                                height: 100vh;
                                width: 100vw;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                text-align: center;
                            ">
                                <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                                <h1 style="font-size: 24px; margin-bottom: 12px; font-weight: 600;">${errorMessage}</h1>
                            </div>
                        `;
                        return true; // –ó–∞—è–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    }
                }
            } catch (error) {
                console.error('‚ùå Error checking existing request:', error);
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É, –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
            }
            
            return false; // –ó–∞—è–≤–∫–∏ –Ω–µ—Ç, –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (tg && tg.initDataUnsafe?.user) {
            console.log('‚úÖ Telegram WebApp initialized');
        } else {
            console.warn('‚ö†Ô∏è Not in Telegram WebApp, but continuing anyway');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–≤—Å–µ–≥–¥–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç Telegram)
        initReceiptUpload();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞—è–≤–∫—É –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π —Ñ–æ—Ä–º—ã
        checkExistingRequest().then((hasExistingRequest) => {
            if (!hasExistingRequest) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∑–∞—Ç–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–µ
                loadPaymentSettings().then(async () => {
                    await createUncreatedOnce();
                    setupBankButtons(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–Ω–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                    loadQR(); // –ó–∞–≥—Ä—É–∂–∞–µ–º QR –∫–æ–¥
                }).catch((error) => {
                    console.error('‚ùå Error initializing payment form:', error);
                    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    setupBankButtons();
                    loadQR();
                });
            }
        });
    </script>
</body>
</html>
