# Процессы автопополнения

> **Важно**: Автопополнение работает **ТОЛЬКО** при создании заявки с фото чека. Email Watcher и Request Watcher больше не вызывают автопополнение.

## 1. Автопополнение при создании заявки (admin/app/api/payment/route.ts:658)
- **Когда запускается**: При создании заявки на пополнение **с фото чека** (`receipt_photo`)
- **Как работает**: 
  1. Пользователь создает заявку на пополнение и отправляет фото чека
  2. Система сразу ищет необработанные платежи с **точной суммой** заявки
  3. Если платеж найден → сразу вызывается `matchAndProcessPayment()`
  4. Пополняется баланс казино и отправляется уведомление с кнопкой "Главное меню"
- **Условие**: Автопополнение срабатывает только если:
  - Заявка типа `deposit`
  - Сумма больше 0
  - **Есть фото чека** (`receipt_photo`)

## 2. Email Watcher (admin/lib/email-watcher.ts:763)
- **Функция**: `startWatcher()`
- **Назначение**: Только сохранение платежей в БД (НЕ вызывает автопополнение)
- **Когда запускается**: Вручную через `npm run start:email-watcher` (не запускается автоматически)
- **Как работает**: 
  - Подключается к IMAP серверу (imap.timeweb.ru:993)
  - Использует IDLE режим с polling каждые **200ms**
  - Проверяет непрочитанные письма за последние **30 минут**
  - Парсит письма от банков через `parseEmailByBank()`
  - **Только сохраняет платежи в таблицу `IncomingPayment`**
  - **НЕ вызывает автопополнение** - платежи обрабатываются только при создании заявки с фото чека

## 3. Match and Process Payment (admin/lib/auto-deposit.ts:343)
- **Функция**: `matchAndProcessPayment(paymentId, amount)`
- **Когда вызывается**: 
  - При создании заявки с фото чека, если найден подходящий платеж
- **Как работает**:
  1. Проверяет, что автопополнение включено (`autodeposit_enabled`)
  2. Ищет pending заявки за последние **5 минут** с точной суммой
  3. Использует **транзакцию** для атомарного обновления:
     - Обновляет статус заявки на `autodeposit_success`
     - Связывает платеж с заявкой (`requestId`)
     - Помечает платеж как обработанный (`isProcessed: true`)
  4. Проверяет на дубликаты (заявки с той же суммой за последние 5 минут)
  5. Вызывает `depositToCasino()` для пополнения баланса
  6. Отправляет уведомление пользователю через Telegram
- **Защита от race condition**: Использует транзакции Prisma для предотвращения двойной обработки

## Взаимодействие процессов

```
Email Watcher получает письмо от банка
    ↓
Email Watcher парсит и сохраняет платеж в БД
    ↓
[Платеж ждет в БД]
    ↓
Пользователь создает заявку на пополнение и отправляет фото чека
    ↓
Система сразу ищет платеж с точной суммой в БД
    ↓
Если платеж найден → вызывается matchAndProcessPayment()
    ↓
matchAndProcessPayment() обрабатывает в транзакции:
  - Обновляет заявку → autodeposit_success
  - Связывает платеж с заявкой
  - Пополняет баланс через Casino API
  - Отправляет уведомление с кнопкой "Главное меню"
```

> **Примечание**: 
> - Автопополнение срабатывает **только** при создании заявки с фото чека
> - Email Watcher только сохраняет платежи в БД, не вызывает автопополнение
> - Request Watcher больше не используется для автопополнения
> - Защита от двойной обработки обеспечивается транзакциями Prisma

## Настройки

- **Автопополнение**: Управляется через `BotConfiguration` или `BotSetting` с ключом `autodeposit_enabled`
- **IMAP настройки**: Фиксированные для Timeweb (imap.timeweb.ru:993)
- **Учетные данные**: Берется из активного реквизита (`BotRequisite` с `isActive=true`)

## Временные интервалы

- **Автопополнение**: Сразу при создании заявки с фото чека (мгновенно)
- **Email Watcher**: Polling каждые **200ms** (IDLE режим) - только для сохранения платежей
- **Окно поиска заявок**: Последние **5 минут** (внутри matchAndProcessPayment)
- **Окно поиска платежей**: Все необработанные платежи без ограничения по времени
- **Окно проверки дубликатов**: Последние **5 минут**
- **Окно проверки писем**: Последние **30 минут**

