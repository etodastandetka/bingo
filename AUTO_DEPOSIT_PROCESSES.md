# Процессы автопополнения

> **Важно**: Автопополнение работает в фоновом режиме для **ВСЕХ** заявок (с фото чека и без), чтобы заявки без чека не появлялись в дашборде.

## 1. Автопополнение при создании заявки (admin/app/api/payment/route.ts)
- **Когда запускается**: При создании заявки на пополнение (**с фото чека или без**)
- **Как работает**: 
  1. Пользователь создает заявку на пополнение (с чеком или без)
  2. Система сразу ищет необработанные платежи с **точной суммой** заявки
  3. Если платеж найден → сразу вызывается `matchAndProcessPayment()`
  4. Пополняется баланс казино и отправляется уведомление с кнопкой "Главное меню"
  5. Если платеж не найден сразу, проверка повторяется через 3 секунды в фоне
- **Условие**: Автопополнение срабатывает если:
  - Заявка типа `deposit`
  - Сумма больше 0
  - **Работает для заявок как с фото чека, так и без него**

## 2. Email Watcher (admin/lib/email-watcher.ts)
- **Функция**: `startWatcher()`
- **Назначение**: Сохранение платежей в БД + **фоновое автопополнение**
- **Когда запускается**: Вручную через `npm run start:email-watcher` (не запускается автоматически)
- **Как работает**: 
  - Подключается к IMAP серверу (imap.timeweb.ru:993)
  - Использует IDLE режим с polling каждые **200ms**
  - Проверяет непрочитанные письма за последние **30 минут**
  - Парсит письма от банков через `parseEmailByBank()`
  - Сохраняет платежи в таблицу `IncomingPayment`
  - **После сохранения платежа сразу ищет все pending заявки (с чеком и без) с такой же суммой**
  - **Вызывает автопополнение в фоне** для найденных заявок, чтобы они не появлялись в дашборде

## 3. Match and Process Payment (admin/lib/auto-deposit.ts:343)
- **Функция**: `matchAndProcessPayment(paymentId, amount)`
- **Когда вызывается**: 
  - При создании заявки с фото чека, если найден подходящий платеж
- **Как работает**:
  1. Проверяет, что автопополнение включено (`autodeposit_enabled`)
  2. Ищет pending заявки за последние **5 минут** с точной суммой
  3. Использует **транзакцию** для атомарного обновления:
     - Обновляет статус заявки на `autodeposit_success`
     - Связывает платеж с заявкой (`requestId`)
     - Помечает платеж как обработанный (`isProcessed: true`)
  4. Проверяет на дубликаты (заявки с той же суммой за последние 5 минут)
  5. Вызывает `depositToCasino()` для пополнения баланса
  6. Отправляет уведомление пользователю через Telegram
- **Защита от race condition**: Использует транзакции Prisma для предотвращения двойной обработки

## Взаимодействие процессов

### Сценарий 1: Платеж пришел до создания заявки
```
Email Watcher получает письмо от банка
    ↓
Email Watcher парсит и сохраняет платеж в БД
    ↓
[Платеж ждет в БД]
    ↓
Пользователь создает заявку на пополнение (с чеком или без)
    ↓
Система сразу ищет платеж с точной суммой в БД
    ↓
Если платеж найден → вызывается matchAndProcessPayment()
    ↓
Заявка обрабатывается мгновенно, не появляется в дашборде
```

### Сценарий 2: Заявка создана до получения платежа
```
Пользователь создает заявку на пополнение (с чеком или без)
    ↓
Система ищет платеж, но не находит (платеж еще не пришел)
    ↓
[Заявка ждет в БД со статусом pending]
    ↓
Email Watcher получает письмо от банка
    ↓
Email Watcher парсит и сохраняет платеж в БД
    ↓
Email Watcher сразу ищет все pending заявки с такой же суммой
    ↓
Если заявка найдена → вызывается matchAndProcessPayment() в фоне
    ↓
Заявка обрабатывается автоматически, не появляется в дашборде
```

> **Примечание**: 
> - Автопополнение работает для **ВСЕХ** заявок (с фото чека и без)
> - Email Watcher вызывает автопополнение в фоне при получении платежа
> - Заявки обрабатываются автоматически и не появляются в дашборде
> - Защита от двойной обработки обеспечивается транзакциями Prisma

## Настройки

- **Автопополнение**: Управляется через `BotConfiguration` или `BotSetting` с ключом `autodeposit_enabled`
- **IMAP настройки**: Фиксированные для Timeweb (imap.timeweb.ru:993)
- **Учетные данные**: Берется из активного реквизита (`BotRequisite` с `isActive=true`)

## Временные интервалы

- **Автопополнение**: Сразу при создании заявки с фото чека (мгновенно)
- **Email Watcher**: Polling каждые **200ms** (IDLE режим) - только для сохранения платежей
- **Окно поиска заявок**: Последние **5 минут** (внутри matchAndProcessPayment)
- **Окно поиска платежей**: Все необработанные платежи без ограничения по времени
- **Окно проверки дубликатов**: Последние **5 минут**
- **Окно проверки писем**: Последние **30 минут**

