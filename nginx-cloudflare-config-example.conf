# Пример конфигурации Nginx для работы с Cloudflare
# Скопируйте этот файл в /etc/nginx/sites-available/ и адаптируйте под свои домены

# ============================================
# Admin Panel Configuration
# ============================================
server {
    listen 80;
    server_name fqxgmrzplndwsyvkeu.ru;

    # Включаем список IP-адресов Cloudflare
    # Сначала создайте файл с IP-адресами: sudo ./update-cloudflare-ips.sh
    include /etc/nginx/conf.d/cloudflare-ips.conf;

    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        
        # Cloudflare передает реальный IP в заголовках
        proxy_set_header X-Real-IP $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-For $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-Proto $cf_scheme;
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        proxy_set_header CF-Ray $http_cf_ray;
        
        proxy_cache_bypass $http_upgrade;
    }
}

# ============================================
# Payment Site Configuration
# ============================================
server {
    listen 80;
    server_name gldwueprxkmbtqsnva.ru;

    # Включаем список IP-адресов Cloudflare
    include /etc/nginx/conf.d/cloudflare-ips.conf;

    location / {
        proxy_pass http://localhost:3003;  # Или 3002, в зависимости от вашей конфигурации
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        
        # Cloudflare передает реальный IP в заголовках
        proxy_set_header X-Real-IP $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-For $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-Proto $cf_scheme;
        proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
        proxy_set_header CF-Ray $http_cf_ray;
        
        proxy_cache_bypass $http_upgrade;
    }
}

# ============================================
# HTTPS Configuration (после получения SSL сертификата)
# ============================================
# Раскомментируйте после настройки SSL через Let's Encrypt

# server {
#     listen 443 ssl http2;
#     server_name fqxgmrzplndwsyvkeu.ru;
# 
#     ssl_certificate /etc/letsencrypt/live/fqxgmrzplndwsyvkeu.ru/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/fqxgmrzplndwsyvkeu.ru/privkey.pem;
# 
#     include /etc/nginx/conf.d/cloudflare-ips.conf;
# 
#     location / {
#         proxy_pass http://localhost:3001;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $http_cf_connecting_ip;
#         proxy_set_header X-Forwarded-For $http_cf_connecting_ip;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
#         proxy_set_header CF-Ray $http_cf_ray;
#         proxy_cache_bypass $http_upgrade;
#     }
# }
# 
# server {
#     listen 443 ssl http2;
#     server_name gldwueprxkmbtqsnva.ru;
# 
#     ssl_certificate /etc/letsencrypt/live/gldwueprxkmbtqsnva.ru/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/gldwueprxkmbtqsnva.ru/privkey.pem;
# 
#     include /etc/nginx/conf.d/cloudflare-ips.conf;
# 
#     location / {
#         proxy_pass http://localhost:3003;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $http_cf_connecting_ip;
#         proxy_set_header X-Forwarded-For $http_cf_connecting_ip;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;
#         proxy_set_header CF-Ray $http_cf_ray;
#         proxy_cache_bypass $http_upgrade;
#     }
# }

