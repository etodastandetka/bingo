# ÐÐ½Ð°Ð»Ð¸Ð· Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº PostgreSQL

## Ð¢ÐµÐºÑƒÑ‰Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ (Ð¸Ð· Ð¿Ð°Ð½ÐµÐ»Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ)

### âœ… Ð¥Ð¾Ñ€Ð¾ÑˆÐ¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸:

1. **`max_connections = 200`**
   - âœ… Ð”Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð»Ñ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸
   - âš ï¸ **Ð’Ð°Ð¶Ð½Ð¾:** Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ `connection_limit` Ð² Prisma Ð½Ðµ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°ÐµÑ‚ ~150 (Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð·Ð°Ð¿Ð°Ñ Ð´Ð»Ñ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹)
   - Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ: Ð•ÑÐ»Ð¸ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ñ‚Ðµ Prisma `connection_limit` Ð´Ð¾ 100, ÑÑ‚Ð¾ Ð±ÑƒÐ´ÐµÑ‚ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾

### âš ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸, Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‰Ð¸Ðµ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ñ:

2. **`shared_buffers = 31232 KB` (~30 MB)**
   - âš ï¸ **Ð¡Ð»Ð¸ÑˆÐºÐ¾Ð¼ Ð¼Ð°Ð»Ð¾** Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ð°
   - Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ: Ð£Ð²ÐµÐ»Ð¸Ñ‡ÑŒÑ‚Ðµ Ð´Ð¾ **128-256 MB** (131072-262144 KB)
   - Ð¤Ð¾Ñ€Ð¼ÑƒÐ»Ð°: Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ 25% Ð¾Ñ‚ RAM, Ð½Ð¾ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 128MB Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ð°

3. **`effective_cache_size = 524288 KB` (~512 MB)**
   - âœ… ÐÐ¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¾Ð³Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð°
   - Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ: ÐœÐ¾Ð¶Ð½Ð¾ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ñ‚ÑŒ Ð´Ð¾ 1-2 GB, ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð°Ñ RAM

4. **`maintenance_work_mem = 33554432 bytes` (~32 MB)**
   - âœ… ÐÐ¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾
   - Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ: ÐœÐ¾Ð¶Ð½Ð¾ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ñ‚ÑŒ Ð´Ð¾ 64-128 MB Ð´Ð»Ñ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ñ VACUUM Ð¸ Ð¸Ð½Ð´ÐµÐºÑÐ°Ñ†Ð¸Ð¸

5. **`autovacuum_max_workers = 3`**
   - âœ… ÐÐ¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ð¾
   - Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ: ÐœÐ¾Ð¶Ð½Ð¾ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ñ‚ÑŒ Ð´Ð¾ 4-5, ÐµÑÐ»Ð¸ Ð‘Ð” Ð±Ð¾Ð»ÑŒÑˆÐ°Ñ

### ðŸ”´ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð²Ð°Ð¶Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ (Ð½Ðµ Ð²Ð¸Ð´Ð½Ñ‹ Ð² Ð¿Ð°Ð½ÐµÐ»Ð¸):

6. **`idle_in_transaction_session_timeout`**
   - âŒ **ÐÐ• Ð£Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•Ð** (ÑÐºÐ¾Ñ€ÐµÐµ Ð²ÑÐµÐ³Ð¾)
   - ðŸ”´ **ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž:** Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ `120000` (2 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹) Ð¸Ð»Ð¸ `60000` (1 Ð¼Ð¸Ð½ÑƒÑ‚Ð°)
   - Ð­Ñ‚Ð¾ ÑƒÐ±ÑŒÐµÑ‚ Ð·Ð°Ð²Ð¸ÑÑˆÐ¸Ðµ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¸, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð´ÐµÑ€Ð¶Ð°Ñ‚ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ
   - **Ð‘ÐµÐ· ÑÑ‚Ð¾Ð³Ð¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° connection_limit Ð½Ðµ Ð¿Ð¾Ð¼Ð¾Ð¶ÐµÑ‚!**

7. **`statement_timeout`**
   - âŒ **ÐÐ• Ð£Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•Ð** (ÑÐºÐ¾Ñ€ÐµÐµ Ð²ÑÐµÐ³Ð¾)
   - Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ `30000` (30 ÑÐµÐºÑƒÐ½Ð´) Ð´Ð»Ñ Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
   - Ð­Ñ‚Ð¾ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‚Ð¸Ñ‚ Ð·Ð°Ð²Ð¸ÑÑˆÐ¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹

8. **`lock_timeout`**
   - âŒ **ÐÐ• Ð£Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•Ð** (ÑÐºÐ¾Ñ€ÐµÐµ Ð²ÑÐµÐ³Ð¾)
   - Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ `10000` (10 ÑÐµÐºÑƒÐ½Ð´)
   - Ð­Ñ‚Ð¾ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‚Ð¸Ñ‚ Ð´Ð¾Ð»Ð³Ð¸Ðµ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸

## Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÐ¼Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ

### ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ 1 (ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž - Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð½ÐµÐ¼ÐµÐ´Ð»ÐµÐ½Ð½Ð¾):

1. **Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ `idle_in_transaction_session_timeout`:**
   ```
   idle_in_transaction_session_timeout = 120000  # 2 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹
   ```
   - Ð­Ñ‚Ð¾ Ð² Ð¿Ð°Ð½ÐµÐ»Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð‘Ð” (ÐµÑÐ»Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾)
   - Ð˜Ð»Ð¸ Ñ‡ÐµÑ€ÐµÐ· SQL: `ALTER SYSTEM SET idle_in_transaction_session_timeout = 120000;`

2. **Ð£Ð²ÐµÐ»Ð¸Ñ‡ÑŒÑ‚Ðµ `shared_buffers`:**
   ```
   shared_buffers = 131072  # 128 MB (Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼)
   ```
   - Ð˜Ð»Ð¸ Ð»ÑƒÑ‡ÑˆÐµ: `262144` (256 MB), ÐµÑÐ»Ð¸ RAM Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚

### ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ 2 (Ð’Ð°Ð¶Ð½Ð¾ - ÑƒÐ»ÑƒÑ‡ÑˆÐ¸Ñ‚ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ):

3. **Ð£Ð²ÐµÐ»Ð¸Ñ‡ÑŒÑ‚Ðµ `maintenance_work_mem`:**
   ```
   maintenance_work_mem = 67108864  # 64 MB
   ```

4. **Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ `statement_timeout`:**
   ```
   statement_timeout = 30000  # 30 ÑÐµÐºÑƒÐ½Ð´
   ```

5. **Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ `lock_timeout`:**
   ```
   lock_timeout = 10000  # 10 ÑÐµÐºÑƒÐ½Ð´
   ```

### ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ 3 (ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾):

6. Ð£Ð²ÐµÐ»Ð¸Ñ‡ÑŒÑ‚Ðµ `effective_cache_size` Ð´Ð¾ 1-2 GB (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ RAM)
7. Ð£Ð²ÐµÐ»Ð¸Ñ‡ÑŒÑ‚Ðµ `autovacuum_max_workers` Ð´Ð¾ 4-5

## ÐšÐ°Ðº Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ

### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 1: Ð§ÐµÑ€ÐµÐ· Ð¿Ð°Ð½ÐµÐ»ÑŒ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð‘Ð”
1. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð² ÑÐ¿Ð¸ÑÐºÐµ
2. Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ
3. Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
4. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð‘Ð” (ÐµÑÐ»Ð¸ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ)

### Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚ 2: Ð§ÐµÑ€ÐµÐ· SQL (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿)
```sql
-- ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
ALTER SYSTEM SET idle_in_transaction_session_timeout = 120000;
ALTER SYSTEM SET statement_timeout = 30000;
ALTER SYSTEM SET lock_timeout = 10000;
ALTER SYSTEM SET shared_buffers = 131072;  -- Ð¸Ð»Ð¸ 262144

-- ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ (Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ° Ð‘Ð”)
SELECT pg_reload_conf();

-- Ð˜Ð»Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð‘Ð” (Ð´Ð»Ñ shared_buffers Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº)
-- sudo systemctl restart postgresql
```

## ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹

```sql
-- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ
SHOW idle_in_transaction_session_timeout;
SHOW statement_timeout;
SHOW lock_timeout;
SHOW shared_buffers;
SHOW max_connections;
```

## Ð¡Ð²ÑÐ·ÑŒ Ñ Prisma Connection Pool

**Ð’Ð°Ð¶Ð½Ð¾ Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ:**
- `max_connections = 200` Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ Ð‘Ð”
- `connection_limit = 50` Ð² Prisma (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ)
- ÐžÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð·Ð°Ð¿Ð°Ñ: 200 - 50 = 150 ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹

**Ð•ÑÐ»Ð¸ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ñ‚Ðµ Prisma Ð´Ð¾ 100:**
- 200 - 100 = 100 ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹ (Ð²ÑÐµ ÐµÑ‰Ðµ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾)

**ÐÐ• ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°Ð¹Ñ‚Ðµ Prisma `connection_limit` Ð±Ð¾Ð»ÑŒÑˆÐµ 150!**
- ÐžÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 50 ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²

## ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³

ÐŸÐ¾ÑÐ»Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:
```sql
-- ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ
SELECT count(*) FROM pg_stat_activity;

-- Ð—Ð°Ð²Ð¸ÑÑˆÐ¸Ðµ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¸ (Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ 0 Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ timeout)
SELECT count(*) FROM pg_stat_activity 
WHERE state = 'idle in transaction' 
AND now() - state_change > interval '2 minutes';

-- Ð”Ð¾Ð»Ð³Ð¸Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹
SELECT pid, now() - query_start as duration, query 
FROM pg_stat_activity 
WHERE state = 'active' 
AND now() - query_start > interval '30 seconds';
```




