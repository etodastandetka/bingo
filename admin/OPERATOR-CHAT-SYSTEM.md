# –°–∏—Å—Ç–µ–º–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä—Å–∫–æ–≥–æ —á–∞—Ç–∞ - –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

## üéØ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∏—Å—Ç–µ–º–∞

### 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –±–æ—Ç—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –≤ Telegram
- –ë–æ—Ç (`telegram_bot/operator_bot.py`) –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
- –ë–æ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API: `POST /api/chat-message`
  - `botType: 'operator'`
  - `direction: 'in'` (–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
  - –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ –ë–î

### 2. –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- API `/api/chat-message` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å (–ø—É–±–ª–∏—á–Ω—ã–π, –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
- –°–æ–∑–¥–∞–µ—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ `users`
- –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `chat_messages` —Å:
  - `bot_type = 'operator'`
  - `direction = 'in'`
  - `user_id`, `message_text`, `created_at` –∏ —Ç.–¥.

### 3. –û–ø–µ—Ä–∞—Ç–æ—Ä –≤–∏–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω–∫–µ
- –ê–¥–º–∏–Ω–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
- API `/api/operator-chats` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É (–æ—Ç–∫—Ä—ã—Ç—ã–µ/–∑–∞–∫—Ä—ã—Ç—ã–µ)
- –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 4. –û–ø–µ—Ä–∞—Ç–æ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —á–∞—Ç
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/dashboard/users/[userId]/operator-chat`
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ `/api/users/[userId]/operator-chat`
- –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º (in/out)

### 5. –û–ø–µ—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç
- –û–ø–µ—Ä–∞—Ç–æ—Ä –≤–≤–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –Ω–∞–∂–∏–º–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
- –°–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ —á–∞—Ç–µ (–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å: `POST /api/users/[userId]/operator-chat`
- API –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram API (OPERATOR_BOT_TOKEN)
- –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î:
  - `botType: 'operator'`
  - `direction: 'out'` (–æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram

## üìã API Endpoints

### –ü—É–±–ª–∏—á–Ω—ã–µ (–¥–ª—è –±–æ—Ç–∞):
- `POST /api/chat-message` - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç CORS
  - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç: `userId`, `messageText`, `botType`, `direction`, –∏ —Ç.–¥.

### –ó–∞—â–∏—â–µ–Ω–Ω—ã–µ (–¥–ª—è –∞–¥–º–∏–Ω–∫–∏):
- `GET /api/operator-chats` - –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
  - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: `?status=open|closed&search=...`
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
  
- `GET /api/users/[userId]/operator-chat` - –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞
  - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  
- `POST /api/users/[userId]/operator-chat` - –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ Telegram API
  - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î

- `PATCH /api/operator-chats` - –ó–∞–∫—Ä—ã—Ç–∏–µ/–æ—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞
  - –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å —á–∞—Ç–∞ –≤ `user_data`

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
- `OPERATOR_BOT_TOKEN` - –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
- `API_BASE_URL` - URL API –¥–ª—è –±–æ—Ç–∞ (–ø—Ä–æ–¥–∞–∫—à–Ω)
- `DATABASE_URL` - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL

### –ü–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞:
- –ê–¥–º–∏–Ω–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É **3001** (–Ω–µ 3000!)
- –ë–æ—Ç –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ `localhost:3001` –∏ `localhost:3000`

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `/api/chat-message` –≤ –ø—É–±–ª–∏—á–Ω—ã–µ —Ä–æ—É—Ç—ã
2. ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω CORS –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º
3. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ `operator-chat/page.tsx`
4. ‚úÖ –£–ª—É—á—à–µ–Ω–æ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–≤ (2-5 —Å–µ–∫—É–Ω–¥)
5. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
6. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω URL –±–æ—Ç–∞ (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ—Ä—Ç—ã 3001 –∏ 3000)
7. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π —Å `botType='operator'`

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
# –¢–µ—Å—Ç –ë–î
npm run test:operator-chat-direct [USER_ID]

# –¢–µ—Å—Ç API (—Ç—Ä–µ–±—É–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä)
node scripts/test-chat-simple.js [USER_ID]
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –≤ Telegram
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—è–≤–∏–ª–æ—Å—å –≤ `/dashboard/operator-chats`
3. –û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å—Ç–æ—Ä–∏—é
4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –æ—Ç–≤–µ—Ç –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### –¢–∞–±–ª–∏—Ü–∞ `chat_messages`:
- `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
- `message_text` - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- `message_type` - –¢–∏–ø (text, photo, video)
- `direction` - –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (in/out)
- `bot_type` - –¢–∏–ø –±–æ—Ç–∞ ('operator' –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä—Å–∫–æ–≥–æ —á–∞—Ç–∞)
- `telegram_message_id` - ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
- `created_at` - –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è

### –¢–∞–±–ª–∏—Ü–∞ `user_data`:
- –•—Ä–∞–Ω–∏—Ç —Å—Ç–∞—Ç—É—Å —á–∞—Ç–∞: `operator_chat_status = 'open'|'closed'`

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞. –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤–º–µ—Å—Ç–µ:
- ‚úÖ –ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ –ê–¥–º–∏–Ω–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —á–∞—Ç—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ –û–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –¥–æ—Ö–æ–¥—è—Ç –¥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ Telegram










